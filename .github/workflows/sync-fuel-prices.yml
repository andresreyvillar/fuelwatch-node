name: Sync Fuel Prices

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    name: Update fuel prices from Ministry API

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync fuel prices
        run: |
          echo "Starting fuel price synchronization..."
          ENDPOINT="https://fuelwatch.pages.dev/api/update-prices"
          echo "Calling: $ENDPOINT"
          
          # Capturar la respuesta y el código HTTP de forma robusta
          full_response=$(curl -s -w "HTTP_STATUS:%{http_code}" "$ENDPOINT")
          http_code=$(echo "$full_response" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          body=$(echo "$full_response" | sed "s/HTTP_STATUS:\$http_code//")

          echo "HTTP Code: $http_code"
          echo "Body: $body"

          if [ "$http_code" = "200" ] && echo "$body" | grep -q "success.*true"; then
            echo "✅ Sync successful!"
            exit 0
          else
            echo "❌ Sync failed (HTTP: $http_code)"
            exit 1
          fi

      - name: Log sync status
        if: always()
        run: |
          echo "Fuel price sync workflow completed at $(date)"
