name: Sync Fuel Prices

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    name: Update fuel prices from Ministry API

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync fuel prices
        run: |
          echo "Starting fuel price synchronization..."
          ENDPOINT="https://fuelwatch.pages.dev/api/update-prices"
          echo "Calling: $ENDPOINT"
          
          response=$(curl -s -w "||%{http_code}" "$ENDPOINT")
          http_code=$(echo "$response" | awk -F"||" "{print \$NF}")
          body=$(echo "$response" | sed "s/||\$http_code//")

          echo "HTTP Code: $http_code"
          echo "Body: $body"

          if [ "$http_code" = "200" ] && echo "$body" | grep -q ""success":true"; then
            echo "✅ Sync successful!"
            exit 0
          else
            echo "❌ Sync failed (HTTP: $http_code)"
            exit 1
          fi

      - name: Log sync status
        if: always()
        run: |
          echo "Fuel price sync workflow completed at $(date)"
