name: Sync Fuel Prices

on:
  schedule:
    # Ejecuta cada hora a las :00 minutos
    - cron: '0 * * * *'
  # Permite ejecutar manualmente desde GitHub
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    name: Update fuel prices from Ministry API

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate configuration
        run: |
          if [ -z "${{ secrets.CRON_TOKEN }}" ]; then
            echo "❌ Error: CRON_TOKEN secret is not configured"
            exit 1
          fi
          echo "✅ CRON_TOKEN is configured"

      - name: Sync fuel prices
        run: |
          echo "Starting fuel price synchronization..."

          SYNC_URL="https://fuelwatch.pages.dev"
          CRON_TOKEN="${{ secrets.CRON_TOKEN }}"
          ENDPOINT="$SYNC_URL/api/update-prices?token=$CRON_TOKEN"

          echo "Calling: $SYNC_URL/api/update-prices"
          echo "Calling endpoint..."

          # Usa -v para verbose y -i para headers
          http_response=$(curl -s -i "$ENDPOINT" 2>&1)

          echo "Full response:"
          echo "$http_response"

          # Extrae código HTTP de la primera línea
          http_code=$(echo "$http_response" | head -1 | grep -oP '\d+' | head -1)
          echo "HTTP Code: $http_code"

          # Extrae body (después de líneas vacías)
          body=$(echo "$http_response" | tail -n +2 | grep -A 100 '^$' | tail -n +2)
          echo "Body: $body"

          # Valida
          if [ "$http_code" = "200" ] && echo "$body" | grep -q '"success":true'; then
            echo "✅ Sync successful!"
            exit 0
          else
            echo "❌ Sync failed (HTTP: $http_code)"
            exit 1
          fi

      - name: Log sync status
        if: always()
        run: |
          echo "Fuel price sync workflow completed at $(date)"
