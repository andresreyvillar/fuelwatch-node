name: Sync Fuel Prices

on:
  schedule:
    # Ejecuta cada hora a las :00 minutos
    - cron: '0 * * * *'
  # Permite ejecutar manualmente desde GitHub
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    name: Update fuel prices from Ministry API

    env:
      # Reemplaza con tu dominio real
      SYNC_URL: ${{ secrets.SYNC_URL || 'https://tu-dominio.com' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate configuration
        run: |
          if [ -z "${{ secrets.CRON_TOKEN }}" ]; then
            echo "❌ Error: CRON_TOKEN secret is not configured"
            echo "Please add CRON_TOKEN to your GitHub repository secrets"
            exit 1
          fi
          if [ -z "${{ secrets.SYNC_URL }}" ]; then
            echo "⚠️  Warning: SYNC_URL not configured, using default"
          fi

      - name: Sync fuel prices
        run: |
          echo "Starting fuel price synchronization..."
          echo "Target: $SYNC_URL/api/update-prices"

          response=$(curl -s -w "\n%{http_code}" \
            "$SYNC_URL/api/update-prices?token=${{ secrets.CRON_TOKEN }}")

          # Separa la respuesta del código HTTP
          body=$(echo "$response" | head -n -1)
          http_code=$(echo "$response" | tail -n 1)

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          # Valida que la respuesta sea exitosa
          if [ "$http_code" != "200" ]; then
            echo "❌ Sync failed with HTTP $http_code"
            exit 1
          fi

          # Valida que sea un JSON válido con "success": true
          if echo "$body" | grep -q '"success":true'; then
            count=$(echo "$body" | grep -oP '"count":\K[0-9]+')
            echo "✅ Sync successful! Updated $count stations"
          else
            echo "❌ Sync returned error: $body"
            exit 1
          fi

      - name: Log sync status
        if: always()
        run: |
          echo "Fuel price sync workflow completed at $(date)"

      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Fuel price sync failed. Check workflow logs.'
            })
